<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
    	        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />        <title>
            Nullege: A Search Engine for Python source code        </title>
        <link rel="search" type="application/opensearchdescription+xml" title="Nullege" href="/opensearch.xml">
        <link href="/favicon.ico" type="image/x-icon" rel="icon" /><link href="/favicon.ico" type="image/x-icon" rel="shortcut icon" /><meta name="description" content="Nullege finds python examples from open source projects. It understands Python and yields more relevant results" /><meta name="keywords" content="Python, examples, search, source code" /><link rel="canonical" href="/codes/show/src@r@o@RouteFlow-HEAD@pox@pox@misc@dns_spy.py"/><link type='text/css' rel='stylesheet' href='/min/b=css&f=jquery.autocomplete.css,nullege.css' /><script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>        <meta property="fb:page_id" content="208737708787" />
        </head>
        <body>
        <!-- google analytics -->
        <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-7648444-4']);
        _gaq.push(['_trackPageview']);

        (function() {
         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
         })();
        </script>
            <div id="container">
                <div id="header">
                </div>
                <div id="content">

                
                <link type='text/css' rel='stylesheet' href='/min/b=css&f=shCore.css,shThemeDefault.css,jqueryFileTree.css' /><div id="searchboxdiv">
<form id="searchboxform" method="GET" action="/codes/search">
    <a href="/"><img src="/img/small_logo.png" id="smalllogo" alt="Logo" title="Nullege Home" /></a>    <input type="text" id="searchbox" name="cq" size="60" maxlength="512" value="pox.lib.packet.dns"/>
    <input type="submit" value="Search"/>
</form>
<script type="text/javascript">
    $(document).ready(function() {
        $("#searchbox").autocomplete("/code_entities/autocomplete", { selectFirst : false, max:1000 })
        .result(function(event, data, formated) {
            $('#searchboxform').submit();
        });

        $(document).bind('keydown', function(event) {
            if (!$("#searchbox").is(":focus")) {
                if(event.keyCode === 191) {    // '/'
                    event.preventDefault();
                    $('#searchbox').focus();
                } else if(event.keyCode === 8) {  // backspace
                    event.preventDefault();
                    $('#searchbox').focus().val($('#searchbox').val());
                }
            }
        });
    });
</script>
</div>
<div class="navsrc">
    <a href="/codes/show/src@m@o@mozilla-ignite-learning-lab-demos-HEAD@lab-6-7-openflow@controller@pox@misc@dns_spy.py/29/pox.lib.packet.dns/python">&lt;&lt; Previous Sample</a> | <a href="/codes/search/pox.lib.packet.dns">Index</a> | <a href="/codes/show/src@p@o@pox-HEAD@pox@proto@dns_spy.py/25/pox.lib.packet.dns/python">Next Sample&gt;&gt;</a></div>
<br/><div id=main>
    <div class="ui-layout-west" id="west-wrapper">
        <div id="filetree_wrapper"><div id="filetree"></div></div>
        <div id="ad_wrapper">
            <div id="ad">
                <script type="text/javascript"><!--
                    google_ad_client = "ca-pub-7605927754820076";
                    /* nullege bottom left */
                    google_ad_slot = "4600706921";
                    google_ad_width = 250;
                    google_ad_height = 250;
                    //-->
                </script>
                <script type="text/javascript"
                        src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
                </script>
            </div>
        </div>
    </div>
    <div id="mainsrc" class="ui-layout-center"><div id="fullsrc" class="fullsrc">
        <div><pre class="brush: python; first-line: 1; highlight:[29] ">
# Copyright 2011-2012 James McCauley
# Copyright 2008 (C) Nicira, Inc.
#
# This file is part of POX.
#
# POX is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# POX is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with POX.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
&nbsp;
&quot;&quot;&quot;
This component spies on DNS replies, stores the results, and raises events
when things are looked up or when its stored mappings are updated.
&nbsp;
Similar to NOX's DNSSpy component, but with more features.
&quot;&quot;&quot;
&nbsp;
from pox.core import core
import pox.openflow.libopenflow_01 as of
import pox.lib.packet as pkt
import pox.lib.packet.dns as pkt_dns
&nbsp;
from pox.lib.addresses import IPAddr
from pox.lib.revent import *
&nbsp;
log = core.getLogger()
&nbsp;
&nbsp;
class DNSUpdate (Event):
  def __init__ (self, item):
    Event.__init__()
    self.item = item
&nbsp;
class DNSLookup (Event):
  def __init__ (self, rr):
    Event.__init__()
&nbsp;
    self.name = rr.name
    self.qtype = rr.qtype
&nbsp;
    self.rr = rr
    for t in pkt_dns.rrtype_to_str.values():
      setattr(self, t, False)
    t = pkt_dns.rrtype_to_str.get(rr.qtype)
    if t is not None:
      setattr(self, t, True)
      setattr(self, &quot;OTHER&quot;, False)
    else:
      setattr(self, &quot;OTHER&quot;, True)
&nbsp;
&nbsp;
class DNSSpy (EventMixin):
  _eventMixin_events = set([ DNSUpdate, DNSLookup ])
&nbsp;
  def __init__ (self, install_flow = True):
    self._install_flow = install_flow
&nbsp;
    self.ip_to_name = {}
    self.name_to_ip = {}
    self.cname = {}
&nbsp;
    core.openflow.addListeners(self)
&nbsp;
    # Add handy function to console
    core.Interactive.variables['lookup'] = self.lookup
&nbsp;
  def _handle_ConnectionUp (self, event):
    if self._install_flow:
      msg = of.ofp_flow_mod()
      msg.match = of.ofp_match()
      msg.match.dl_type = pkt.ethernet.IP_TYPE
      msg.match.nw_proto = pkt.ipv4.UDP_PROTOCOL
      msg.match.tp_src = 53
      msg.actions.append(of.ofp_action_output(port = of.OFPP_CONTROLLER))
      event.connection.send(msg)
&nbsp;
  def lookup (self, something):
    if something in self.name_to_ip:
      return self.name_to_ip[something]
    if something in self.cname:
      return self.lookup(self.cname[something])
    try:
      return self.ip_to_name.get(IPAddr(something))
    except:
      return None
&nbsp;
  def _record (self, ip, name):
    # Handle reverse lookups correctly?
    modified = False
    val = self.ip_to_name.setdefault(ip, [])
    if name not in val:
      val.insert(0, name)
      modified = True
&nbsp;
    val = self.name_to_ip.setdefault(name, [])
    if ip not in val:
      val.insert(0, ip)
      modified = True
&nbsp;
    return modified
&nbsp;
  def _record_cname (self, name, cname):
    modified = False
    val = self.cname.setdefault(name, [])
    if name not in val:
      val.insert(0, cname)
      modified = True
&nbsp;
    return modified
&nbsp;
  def _handle_PacketIn (self, event):
    p = event.parsed.find('dns')
&nbsp;
    if p is not None and p.parsed:
      log.debug(p)
&nbsp;
      for q in p.questions:
        if q.qclass != 1: continue # Internet only
        self.raiseEvent(DNSLookup, q)
&nbsp;
      def process_q (entry):
        if entry.qclass != 1:
          # Not internet
          return
&nbsp;
        if entry.qtype == pkt.dns.rr.CNAME_TYPE:
          if self._record_cname(entry.name, entry.rddata):
            self.raiseEvent(DNSUpdate, entry.name)
            log.info(&quot;add cname entry: %s %s&quot; % (entry.rddata, entry.name))
        elif entry.qtype == pkt.dns.rr.A_TYPE:
          if self._record(entry.rddata, entry.name):
            self.raiseEvent(DNSUpdate, entry.name)
            log.info(&quot;add dns entry: %s %s&quot; % (entry.rddata, entry.name))
&nbsp;
      for answer in p.answers:
        process_q(answer)
      for addition in p.additional:
        process_q(addition)
&nbsp;
&nbsp;
def launch (no_flow = False):
  core.registerNew(DNSSpy, not no_flow)
&nbsp;
</pre></div>    </div></div>
</div>

<script type="text/javascript">
    $().ready(function(){
        var main_height = $(window).height() - 110;
        main_height = main_height < 300 ? 300 : main_height;
        $('#main').height(main_height);

        $('#main').layout( {
            applyDefaultStyles: true
            , west__size: 300
        });
        $('#west-wrapper').layout( {
            center__paneSelector: '#filetree_wrapper',
            south__paneSelector: '#ad_wrapper',
            south__size: 250
        })
        SyntaxHighlighter.highlight();
        var line = 29;
        var div = $('div.number' + line);
        var top = $(div).position().top;
        if(top > 200)
            $('#mainsrc').scrollTop(top - 200);

        var proj_root = "r/o/RouteFlow-HEAD";
        var proj_init_path = "pox/pox/misc/dns_spy.py";
        $('#filetree').fileTree({root: proj_root + '/', initpath: proj_init_path, script: "/jqueryFileTree.php"},
        function(file) {
            file = 'src/' + file;
            base = "/";
            $.get(base + 'code_entities/show_raw/' + file.replace(/\//g, '@'), function(data) {
                $('#fullsrc').html(data);
                SyntaxHighlighter.highlight();
            });
        }
    );
    });
</script>
<script type='text/javascript' src='/min/b=js&f=shCore.js,shBrushPython.js,jqueryFileTree.js,jquery.layout.js'></script>


            </div>
            <div id="footer">
                <a href="/pages/about">About Us (Contact Us)</a> |
                <a href="/pages/privacy">Privacy</a> |
                <a href="http://twitter.com/nullege">Twitter</a> |
                <a href="http://www.facebook.com/pages/nullege/208737708787">Facebook</a> |
                <a href="javascript:UserVoice.showPopupWidget();" title="Open feedback & support dialog (powered by UserVoice)">Feedback</a>
                            </div>
        </div>
                <script type='text/javascript' src='/min/b=js&f=jquery.autocomplete.js'></script>
        <!-- user voice -->
        <script type="text/javascript">
            (function() {
                var uv = document.createElement('script'); uv.type = 'text/javascript'; uv.async = true;
                uv.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'widget.uservoice.com/ed9ETa1MDOo2yB4DbS4gQ.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(uv, s);
            })();
        </script>
    </body>
</html>
